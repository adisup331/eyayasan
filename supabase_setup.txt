-- JALANKAN SCRIPT INI DI SQL EDITOR SUPABASE UNTUK UPDATE DATABASE

-- 1. Buat Tabel Foundations (Yayasan)
create table if not exists public.foundations (
  id uuid default gen_random_uuid() primary key,
  name text not null,
  slug text,
  address text,
  features text[], -- Array of strings: ['EVENTS', 'FINANCE', 'EDUCATORS', etc.]
  created_at timestamp with time zone default now()
);

-- Enable RLS Foundations
alter table public.foundations enable row level security;
create policy "Enable all access for foundations" on public.foundations for all using (true) with check (true);

-- 2. Update Tabel Organizations (Tambah Type & Foundation_ID)
do $$
begin
  if not exists (select 1 from information_schema.columns where table_name = 'organizations' and column_name = 'type') then
    alter table public.organizations add column type text default 'General'; -- 'Education' or 'General'
  end if;

  if not exists (select 1 from information_schema.columns where table_name = 'organizations' and column_name = 'foundation_id') then
    alter table public.organizations add column foundation_id uuid references public.foundations(id) on delete cascade;
  end if;
end $$;

-- 3. Update Tabel Members (Tambah Foundation_ID)
do $$
begin
  if not exists (select 1 from information_schema.columns where table_name = 'members' and column_name = 'foundation_id') then
    alter table public.members add column foundation_id uuid references public.foundations(id) on delete set null;
  end if;
end $$;

-- 4. Insert Default Foundation (Agar data lama tidak error)
INSERT INTO public.foundations (name, features)
SELECT 'Yayasan Utama', ARRAY['DASHBOARD', 'EVENTS', 'EDUCATORS', 'FINANCE', 'ORGANIZATIONS', 'MEMBERS', 'ROLES', 'DIVISIONS', 'PROGRAMS']
WHERE NOT EXISTS (SELECT 1 FROM public.foundations LIMIT 1);

-- 5. Update data lama ke Foundation default
DO $$
DECLARE
    default_foundation_id uuid;
BEGIN
    SELECT id INTO default_foundation_id FROM public.foundations LIMIT 1;
    
    UPDATE public.organizations SET foundation_id = default_foundation_id WHERE foundation_id IS NULL;
    UPDATE public.members SET foundation_id = default_foundation_id WHERE foundation_id IS NULL;
END $$;

-- Update Permissions Role Super Admin untuk akses Master Yayasan
UPDATE roles 
SET permissions = array_append(permissions, 'MASTER_FOUNDATION')
WHERE (name = 'Super Administration' OR name = 'Super Admin') 
AND NOT ('MASTER_FOUNDATION' = ANY(permissions));
