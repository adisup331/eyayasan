
-- JALANKAN SCRIPT INI DI SQL EDITOR SUPABASE UNTUK UPDATE DATABASE

-- 1. Buat Tabel Foundations (Yayasan) jika belum ada
create table if not exists public.foundations (
  id uuid default gen_random_uuid() primary key,
  name text not null,
  slug text,
  address text,
  features text[], -- Array of strings: ['EVENTS', 'FINANCE', 'EDUCATORS', etc.]
  created_at timestamp with time zone default now()
);

-- UPDATE: Tambah Kolom PIN Aktivasi
do $$
begin
  if not exists (select 1 from information_schema.columns where table_name = 'foundations' and column_name = 'activation_pin') then
    alter table public.foundations add column activation_pin text default '123456'; 
  end if;
end $$;

-- UPDATE: Tambah Kolom Dashboard Config
do $$
begin
  if not exists (select 1 from information_schema.columns where table_name = 'foundations' and column_name = 'dashboard_config') then
    alter table public.foundations add column dashboard_config text[]; 
  end if;
end $$;

-- Enable RLS Foundations
alter table public.foundations enable row level security;

do $$
begin
  if not exists (select 1 from pg_policies where policyname = 'Enable all access for foundations' and tablename = 'foundations') then
    create policy "Enable all access for foundations" on public.foundations for all using (true) with check (true);
  end if;
end $$;

-- 2. Update Tabel Organizations (Tambah Type & Foundation_ID)
do $$
begin
  if not exists (select 1 from information_schema.columns where table_name = 'organizations' and column_name = 'type') then
    alter table public.organizations add column type text default 'General'; 
  end if;

  if not exists (select 1 from information_schema.columns where table_name = 'organizations' and column_name = 'foundation_id') then
    alter table public.organizations add column foundation_id uuid references public.foundations(id) on delete cascade;
  end if;
end $$;

-- 3. NEW: Tabel Groups (Kelompok)
create table if not exists public.groups (
  id uuid default gen_random_uuid() primary key,
  name text not null,
  description text,
  organization_id uuid references public.organizations(id) on delete cascade,
  foundation_id uuid references public.foundations(id) on delete cascade,
  created_at timestamp with time zone default now()
);
alter table public.groups enable row level security;
do $$
begin
  if not exists (select 1 from pg_policies where policyname = 'Enable all access for groups' and tablename = 'groups') then
    create policy "Enable all access for groups" on public.groups for all using (true) with check (true);
  end if;
end $$;

-- Add Index for Groups
CREATE INDEX IF NOT EXISTS idx_groups_organization_id ON public.groups(organization_id);


-- 4. Update Tabel Members (Tambah Foundation_ID, Detail Anggota, Group_ID) & Policy Public Read
do $$
begin
  -- Kolom Relasi Yayasan
  if not exists (select 1 from information_schema.columns where table_name = 'members' and column_name = 'foundation_id') then
    alter table public.members add column foundation_id uuid references public.foundations(id) on delete set null;
  end if;
  
  -- Kolom Relasi Group (Kelompok)
  if not exists (select 1 from information_schema.columns where table_name = 'members' and column_name = 'group_id') then
    alter table public.members add column group_id uuid references public.groups(id) on delete set null;
  end if;

  -- Kolom Detail Tenaga Pendidik / Anggota
  if not exists (select 1 from information_schema.columns where table_name = 'members' and column_name = 'gender') then
    alter table public.members add column gender text; -- 'L' or 'P'
  end if;
  if not exists (select 1 from information_schema.columns where table_name = 'members' and column_name = 'origin') then
    alter table public.members add column origin text; -- Asal / Domisili
  end if;
  if not exists (select 1 from information_schema.columns where table_name = 'members' and column_name = 'birth_date') then
    alter table public.members add column birth_date date;
  end if;
  if not exists (select 1 from information_schema.columns where table_name = 'members' and column_name = 'service_period') then
    alter table public.members add column service_period text; -- String display 'dd MMM yyyy - dd MMM yyyy'
  end if;
  if not exists (select 1 from information_schema.columns where table_name = 'members' and column_name = 'service_end_date') then
    alter table public.members add column service_end_date date; -- Used for expiration alerts
  end if;
end $$;

-- Add Indexes for Performance
CREATE INDEX IF NOT EXISTS idx_members_service_end_date ON public.members(service_end_date);
CREATE INDEX IF NOT EXISTS idx_members_organization_id ON public.members(organization_id);
CREATE INDEX IF NOT EXISTS idx_members_group_id ON public.members(group_id);

-- PENTING: Policy agar halaman Login bisa mengecek apakah email sudah terdaftar sebagai anggota
DROP POLICY IF EXISTS "Enable read access for all users" ON public.members;
CREATE POLICY "Enable read access for all users" ON public.members FOR SELECT USING (true);

-- Enable write access for authenticated users (untuk Super Admin & Admin Yayasan)
DROP POLICY IF EXISTS "Enable insert for authenticated users only" ON public.members;
CREATE POLICY "Enable insert for authenticated users only" ON public.members FOR INSERT TO authenticated WITH CHECK (true);

DROP POLICY IF EXISTS "Enable update for authenticated users only" ON public.members;
CREATE POLICY "Enable update for authenticated users only" ON public.members FOR UPDATE TO authenticated USING (true);

DROP POLICY IF EXISTS "Enable delete for authenticated users only" ON public.members;
CREATE POLICY "Enable delete for authenticated users only" ON public.members FOR DELETE TO authenticated USING (true);


-- 5. TAMBAHAN: Update Tabel Lain untuk Isolasi Data (Roles, Divisions, Programs, Events)
do $$
begin
  -- Roles
  if not exists (select 1 from information_schema.columns where table_name = 'roles' and column_name = 'foundation_id') then
    alter table public.roles add column foundation_id uuid references public.foundations(id) on delete cascade;
  end if;
  if not exists (select 1 from information_schema.columns where table_name = 'roles' and column_name = 'permissions') then
    alter table public.roles add column permissions text[];
  end if;

  -- Divisions
  if not exists (select 1 from information_schema.columns where table_name = 'divisions' and column_name = 'foundation_id') then
    alter table public.divisions add column foundation_id uuid references public.foundations(id) on delete cascade;
  end if;
  -- Programs
  if not exists (select 1 from information_schema.columns where table_name = 'programs' and column_name = 'foundation_id') then
    alter table public.programs add column foundation_id uuid references public.foundations(id) on delete cascade;
  end if;
  -- Events
  if not exists (select 1 from information_schema.columns where table_name = 'events' and column_name = 'foundation_id') then
    alter table public.events add column foundation_id uuid references public.foundations(id) on delete cascade;
  end if;
end $$;


-- 6. Insert Default Foundation / Update Existing
INSERT INTO public.foundations (name, features, activation_pin)
SELECT 'Yayasan Bina Karakter Luhur', ARRAY['DASHBOARD', 'EVENTS', 'EDUCATORS', 'FINANCE', 'ORGANIZATIONS', 'MEMBERS', 'ROLES', 'DIVISIONS', 'PROGRAMS', 'GROUPS'], '123456'
WHERE NOT EXISTS (SELECT 1 FROM public.foundations LIMIT 1);

UPDATE public.foundations 
SET name = 'Yayasan Bina Karakter Luhur', features = ARRAY['DASHBOARD', 'EVENTS', 'EDUCATORS', 'FINANCE', 'ORGANIZATIONS', 'MEMBERS', 'ROLES', 'DIVISIONS', 'PROGRAMS', 'GROUPS']
WHERE name = 'Yayasan Utama' OR name = 'Yayasan Bina Karakter Luhur';

-- 7. MIGRASI DATA
DO $$
DECLARE
    default_foundation_id uuid;
BEGIN
    SELECT id INTO default_foundation_id FROM public.foundations ORDER BY created_at ASC LIMIT 1;
    
    IF default_foundation_id IS NOT NULL THEN
        UPDATE public.organizations SET foundation_id = default_foundation_id WHERE foundation_id IS NULL;
        UPDATE public.members SET foundation_id = default_foundation_id WHERE foundation_id IS NULL;
        UPDATE public.roles SET foundation_id = default_foundation_id WHERE foundation_id IS NULL AND name NOT ILIKE 'Super%'; 
        UPDATE public.divisions SET foundation_id = default_foundation_id WHERE foundation_id IS NULL;
        UPDATE public.programs SET foundation_id = default_foundation_id WHERE foundation_id IS NULL;
        UPDATE public.events SET foundation_id = default_foundation_id WHERE foundation_id IS NULL;
        
        -- FORCE ENABLE GROUPS FEATURE FOR DEFAULT FOUNDATION
        UPDATE public.foundations 
        SET features = array_append(features, 'GROUPS')
        WHERE id = default_foundation_id AND NOT ('GROUPS' = ANY(features));
    END IF;
END $$;

-- Update Permissions Role Super Admin (Force Add GROUPS)
UPDATE roles 
SET permissions = ARRAY['DASHBOARD', 'MEMBERS', 'DIVISIONS', 'ORGANIZATIONS', 'PROGRAMS', 'ROLES', 'EVENTS', 'FINANCE', 'EDUCATORS', 'GROUPS', 'MASTER_FOUNDATION']
WHERE (name = 'Super Administration' OR name = 'Super Admin');
