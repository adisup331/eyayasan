
-- ==========================================
-- E-YAYASAN DATABASE SETUP & MIGRATION SCRIPT
-- ==========================================
-- Run this script in the Supabase SQL Editor.
-- It is safe to run multiple times (Idempotent).

-- 1. ENABLE EXTENSIONS
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 2. TABLE: FOUNDATIONS
CREATE TABLE IF NOT EXISTS public.foundations (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    name text NOT NULL,
    slug text,
    address text,
    features text[],
    created_at timestamp with time zone DEFAULT now()
);

-- Migrations for Foundations
DO $$ 
BEGIN 
    ALTER TABLE public.foundations ADD COLUMN IF NOT EXISTS dashboard_config text[];
    ALTER TABLE public.foundations ADD COLUMN IF NOT EXISTS activation_pin text DEFAULT '123456';
END $$;

-- 3. TABLE: ORGANIZATIONS
CREATE TABLE IF NOT EXISTS public.organizations (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    name text NOT NULL,
    description text,
    type text DEFAULT 'General',
    foundation_id uuid REFERENCES public.foundations(id) ON DELETE CASCADE,
    created_at timestamp with time zone DEFAULT now()
);

-- 4. TABLE: GROUPS (NEW FEATURE - Critical for Member Portal)
CREATE TABLE IF NOT EXISTS public.groups (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    name text NOT NULL,
    description text,
    organization_id uuid REFERENCES public.organizations(id) ON DELETE CASCADE,
    foundation_id uuid REFERENCES public.foundations(id) ON DELETE CASCADE,
    created_at timestamp with time zone DEFAULT now()
);

-- 5. TABLE: ROLES
CREATE TABLE IF NOT EXISTS public.roles (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    name text NOT NULL,
    permissions text[],
    foundation_id uuid REFERENCES public.foundations(id) ON DELETE CASCADE,
    created_at timestamp with time zone DEFAULT now()
);

-- Migrations for Roles
DO $$ 
BEGIN 
    ALTER TABLE public.roles ADD COLUMN IF NOT EXISTS requires_service_period boolean DEFAULT false;
END $$;

-- 6. TABLE: DIVISIONS
-- Note: We do NOT add head_member_id here yet to avoid circular dependency error if members table doesn't exist
CREATE TABLE IF NOT EXISTS public.divisions (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    name text NOT NULL,
    description text,
    foundation_id uuid REFERENCES public.foundations(id) ON DELETE CASCADE,
    created_at timestamp with time zone DEFAULT now()
);

-- 7. TABLE: MEMBERS
CREATE TABLE IF NOT EXISTS public.members (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    full_name text NOT NULL,
    email text NOT NULL,
    phone text,
    role_id uuid REFERENCES public.roles(id) ON DELETE SET NULL,
    division_id uuid REFERENCES public.divisions(id) ON DELETE SET NULL,
    organization_id uuid REFERENCES public.organizations(id) ON DELETE SET NULL,
    foundation_id uuid REFERENCES public.foundations(id) ON DELETE CASCADE,
    created_at timestamp with time zone DEFAULT now()
);

-- Migrations for Members (New Columns)
DO $$ 
BEGIN 
    -- Ensure created_at exists (Fix for error 42703)
    ALTER TABLE public.members ADD COLUMN IF NOT EXISTS created_at timestamp with time zone DEFAULT now();
    
    ALTER TABLE public.members ADD COLUMN IF NOT EXISTS group_id uuid REFERENCES public.groups(id) ON DELETE SET NULL;
    ALTER TABLE public.members ADD COLUMN IF NOT EXISTS gender text;
    ALTER TABLE public.members ADD COLUMN IF NOT EXISTS origin text;
    ALTER TABLE public.members ADD COLUMN IF NOT EXISTS birth_date date;
    ALTER TABLE public.members ADD COLUMN IF NOT EXISTS service_period text;
    ALTER TABLE public.members ADD COLUMN IF NOT EXISTS service_end_date timestamp with time zone;
    ALTER TABLE public.members ADD COLUMN IF NOT EXISTS status text DEFAULT 'Active';
    -- UPDATE TERBARU (Kelompok Santri): Tambah Kolom Kelas/Grade
    ALTER TABLE public.members ADD COLUMN IF NOT EXISTS grade text;
    -- UPDATE TERBARU (Tipe Anggota): Generus / Lima Unsur
    ALTER TABLE public.members ADD COLUMN IF NOT EXISTS member_type text DEFAULT 'Generus';
END $$;

-- CLEANUP DUPLICATES BEFORE UNIQUE CONSTRAINT
-- This deletes older duplicates keeping the latest one based on created_at
-- If created_at was just added, they are equal, so it deletes arbitrary duplicates (rnum > 1)
DELETE FROM public.members
WHERE id IN (
    SELECT id FROM (
        SELECT id, ROW_NUMBER() OVER (partition BY email ORDER BY created_at DESC) AS rnum
        FROM public.members
    ) t
    WHERE t.rnum > 1
);

-- Ensure Email is Unique for Upsert Logic
DO $$ 
BEGIN 
    IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'members_email_key') THEN
        ALTER TABLE public.members ADD CONSTRAINT members_email_key UNIQUE (email);
    END IF;
END $$;

-- Fix Circular Dependency for Divisions (Head Member & Order)
-- Now that 'members' table definitely exists, we can add the columns to 'divisions'
DO $$ 
BEGIN 
    ALTER TABLE public.divisions ADD COLUMN IF NOT EXISTS head_member_id uuid REFERENCES public.members(id) ON DELETE SET NULL;
    ALTER TABLE public.divisions ADD COLUMN IF NOT EXISTS order_index serial;
END $$;

-- 8. TABLE: PROGRAMS
CREATE TABLE IF NOT EXISTS public.programs (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    name text NOT NULL,
    description text,
    cost numeric DEFAULT 0,
    month text, -- JSON String
    year integer,
    division_id uuid REFERENCES public.divisions(id) ON DELETE CASCADE,
    organization_id uuid REFERENCES public.organizations(id) ON DELETE SET NULL,
    foundation_id uuid REFERENCES public.foundations(id) ON DELETE CASCADE,
    status text DEFAULT 'Planned',
    created_at timestamp with time zone DEFAULT now()
);

-- Migrations for Programs
DO $$ 
BEGIN 
    ALTER TABLE public.programs ADD COLUMN IF NOT EXISTS proof_url text;
    ALTER TABLE public.programs ADD COLUMN IF NOT EXISTS doc_url text;
END $$;

-- 9. TABLE: EVENTS
CREATE TABLE IF NOT EXISTS public.events (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    name text NOT NULL,
    date timestamp with time zone NOT NULL,
    location text,
    description text,
    status text DEFAULT 'Upcoming',
    foundation_id uuid REFERENCES public.foundations(id) ON DELETE CASCADE,
    created_at timestamp with time zone DEFAULT now()
);

-- Migrations for Events (Late Tolerance & Real-time)
DO $$ 
BEGIN 
    ALTER TABLE public.events ADD COLUMN IF NOT EXISTS late_tolerance integer DEFAULT 15;
    ALTER TABLE public.events ADD COLUMN IF NOT EXISTS actual_start_time timestamp with time zone;
    -- UPDATE TERBARU: Event Type
    ALTER TABLE public.events ADD COLUMN IF NOT EXISTS event_type text DEFAULT 'Pengajian';
END $$;

-- 10. TABLE: EVENT_ATTENDANCE
CREATE TABLE IF NOT EXISTS public.event_attendance (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    event_id uuid REFERENCES public.events(id) ON DELETE CASCADE,
    member_id uuid REFERENCES public.members(id) ON DELETE CASCADE,
    status text DEFAULT 'Absent',
    notes text,
    created_at timestamp with time zone DEFAULT now()
);

-- Migrations for Attendance (Check In Time)
DO $$ 
BEGIN 
    ALTER TABLE public.event_attendance ADD COLUMN IF NOT EXISTS check_in_time timestamp with time zone;
END $$;

-- Ensure Unique Constraint on Attendance
DO $$ 
BEGIN 
    IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'event_attendance_event_id_member_id_key') THEN
        ALTER TABLE public.event_attendance ADD CONSTRAINT event_attendance_event_id_member_id_key UNIQUE (event_id, member_id);
    END IF;
END $$;

-- ==========================================
-- ROW LEVEL SECURITY (RLS) POLICIES
-- ==========================================
-- For this CMS, we enable Public Read/Write access for simplicity 
-- assuming the app handles auth logic or it's an internal tool.

-- Helper macro to reset policies
DO $$
DECLARE 
    t text;
BEGIN 
    FOR t IN 
        SELECT table_name FROM information_schema.tables 
        WHERE table_schema = 'public' 
        AND table_type = 'BASE TABLE'
    LOOP
        EXECUTE format('ALTER TABLE public.%I ENABLE ROW LEVEL SECURITY', t);
        EXECUTE format('DROP POLICY IF EXISTS "Enable all access for %I" ON public.%I', t, t);
        EXECUTE format('CREATE POLICY "Enable all access for %I" ON public.%I FOR ALL USING (true) WITH CHECK (true)', t, t);
    END LOOP;
END $$;

-- ==========================================
-- SEED DATA & PERMISSIONS
-- ==========================================

-- Ensure Super Admin Role Exists and has updated permissions
DO $$
DECLARE
    super_role_id uuid;
BEGIN
    -- Check/Create Role
    IF NOT EXISTS (SELECT 1 FROM public.roles WHERE name = 'Super Administration') THEN
        INSERT INTO public.roles (name, permissions) 
        VALUES ('Super Administration', ARRAY['DASHBOARD', 'MEMBERS', 'DIVISIONS', 'ORGANIZATIONS', 'GROUPS', 'PROGRAMS', 'ROLES', 'EVENTS', 'FINANCE', 'EDUCATORS', 'MASTER_FOUNDATION', 'PROFILE', 'DOCUMENTATION'])
        RETURNING id INTO super_role_id;
    ELSE
        -- Update permissions if exists to include new features (GROUPS, DOCUMENTATION)
        UPDATE public.roles 
        SET permissions = ARRAY['DASHBOARD', 'MEMBERS', 'DIVISIONS', 'ORGANIZATIONS', 'GROUPS', 'PROGRAMS', 'ROLES', 'EVENTS', 'FINANCE', 'EDUCATORS', 'MASTER_FOUNDATION', 'PROFILE', 'DOCUMENTATION']
        WHERE name = 'Super Administration';
    END IF;
END $$;

-- Insert Super Admin User if not exists
INSERT INTO public.members (full_name, email, role_id)
SELECT 'Super Admin', 'super@yayasan.org', id FROM public.roles WHERE name = 'Super Administration'
ON CONFLICT (email) DO NOTHING; 
